<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Yamanote Line - Stations on Circle with Dark Mode</title>
  <!-- Basic Content Security Policy (adjust if needed) -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Circle wrapper for arrows and station labels -->
  <div id="circleWrapper">
    <div id="arrowContainer"></div>
    <div id="stations"></div>
  </div>

  <!-- Audio bar fixed at the bottom (single horizontal row) -->
  <div id="audioPlayer">
    <div class="left-controls">
      <div class="volume-control">
        <span class="volume-label">Announcement</span>
        <button class="volume-icon" id="announcementVolumeIcon">🔊</button>
        <input type="range" id="announcementVolumeSlider" min="0" max="1" step="0.01" value="1">
      </div>
      <div class="volume-control">
        <span class="volume-label">Station</span>
        <button class="volume-icon" id="stationVolumeIcon">🔊</button>
        <input type="range" id="stationVolumeSlider" min="0" max="1" step="0.01" value="1">
      </div>
    </div>
    <div class="center-controls">
      <span id="currentStation">No station selected</span>
      <button id="playPauseBtn" class="control-button">▶</button>
    </div>
    <div class="right-controls">
      <div class="switch-control">
        <span id="skipText">Skip Announcements</span>
        <label class="switch">
          <input type="checkbox" id="skipAnnouncement">
          <span class="slider round"></span>
        </label>
      </div>
      <div class="switch-control">
        <span id="directionText">Clockwise</span>
        <label class="switch">
          <input type="checkbox" id="directionToggle" checked>
          <span class="slider round"></span>
        </label>
      </div>
      <div class="switch-control">
        <span id="darkModeText">Light Mode</span>
        <label class="switch">
          <input type="checkbox" id="darkModeToggle">
          <span class="slider round"></span>
        </label>
      </div>
    </div>
  </div>

  <!-- Hidden audio element for playback -->
  <audio id="audio" preload="auto"></audio>

  <script>
    // Cache-busting query parameter
    const cacheBust = "?v=1";

    // All 29 Yamanote line stations, referencing ./announcements and ./Sounds
    const stations = [
      { name: "Tokyo",          mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/tokyo-announcement.mp3",       mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/tokyo.mp3" },
      { name: "Kanda",          mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/kanda-announcement.mp3",       mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/kanda.mp3" },
      { name: "Akihabara",      mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/akihabara-announcement.mp3",   mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/akihabara.mp3" },
      { name: "Okachimachi",    mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/okachimachi-announcement.mp3", mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/okachimachi.mp3" },
      { name: "Ueno",           mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/ueno-announcement.mp3",        mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/ueno.mp3" },
      { name: "Uguisudani",     mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/uguisudani-announcement.mp3",  mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/uguisudani.mp3" },
      { name: "Nippori",        mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/nippori-announcement.mp3",     mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/nippori.mp3" },
      { name: "Nishi-Nippori",  mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/nishi-Nippori-announcement.mp3", mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/nishi-Nippori.mp3" },
      { name: "Tabata",         mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/tabata-announcement.mp3",      mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/tabata.mp3" },
      { name: "Komagome",       mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/komagome-announcement.mp3",    mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/komagome.mp3" },
      { name: "Sugamo",         mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/sugamo-announcement.mp3",      mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/sugamo.mp3" },
      { name: "Otsuka",         mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/otsuka-announcement.mp3",      mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/otsuka.mp3" },
      { name: "Ikebukuro",      mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/ikebukuro-announcement.mp3",   mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/ikebukuro.mp3" },
      { name: "Mejiro",         mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/mejiro-announcement.mp3",      mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/mejiro.mp3" },
      { name: "Takadanobaba",   mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/takadanobaba-announcement.mp3", mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/takadanobaba.mp3" },
      { name: "Shin-Okubo",     mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/shin-Okubo-announcement.mp3",  mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/shin-Okubo.mp3" },
      { name: "Shinjuku",       mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/shinjuku-announcement.mp3",    mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/shinjuku.mp3" },
      { name: "Yoyogi",         mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/yoyogi-announcement.mp3",      mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/yoyogi.mp3" },
      { name: "Harajuku",       mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/harajuku-announcement.mp3",    mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/harajuku.mp3" },
      { name: "Shibuya",        mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/shibuya-announcement.mp3",     mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/shibuya.mp3" },
      { name: "Ebisu",          mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/ebisu-announcement.mp3",       mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/ebisu.mp3" },
      { name: "Meguro",         mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/meguro-announcement.mp3",      mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/meguro.mp3" },
      { name: "Gotanda",        mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/gotanda-announcement.mp3",     mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/gotanda.mp3" },
      { name: "Osaki",          mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/osaki-announcement.mp3",       mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/osaki.mp3" },
      { name: "Shinagawa",      mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/shinagawa-announcement.mp3",   mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/shinagawa.mp3" },
      { name: "Tamachi",        mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/tamachi-announcement.mp3",     mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/tamachi.mp3" },
      { name: "Hamamatsucho",   mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/hamamatsucho-announcement.mp3", mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/hamamatsucho.mp3" },
      { name: "Shimbashi",      mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/shimbashi-announcement.mp3",   mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/shimbashi.mp3" },
      { name: "Yurakucho",      mp3Announcement: "https://www.madewithonlyai.com/Sites/yamanoteline/announcements/yurakucho-announcement.mp3",   mp3Station: "https://www.madewithonlyai.com/Sites/yamanoteline/Sounds/yurakucho.mp3" }
    ];

    let currentStationIndex = -1;
    let announcementVolume = 1, stationVolume = 1;
    let announcementMuted = false, stationMuted = false;
    let currentAudioType = ""; // "announcement" or "station"
    let playDirection = 1;     // +1 = clockwise, -1 = counterclockwise

    const audioElement = document.getElementById("audio");
    const currentStationLabel = document.getElementById("currentStation");
    const skipAnnouncementToggle = document.getElementById("skipAnnouncement");
    const directionToggle = document.getElementById("directionToggle");
    const directionText = document.getElementById("directionText");
    const darkModeToggle = document.getElementById("darkModeToggle");
    const darkModeText = document.getElementById("darkModeText");
    const playPauseBtn = document.getElementById("playPauseBtn");

    // Dark mode toggle
    darkModeToggle.addEventListener("change", () => {
      if (darkModeToggle.checked) {
        document.body.classList.add("dark-mode");
        darkModeText.textContent = "Dark Mode";
      } else {
        document.body.classList.remove("dark-mode");
        darkModeText.textContent = "Light Mode";
      }
    });

    // Log audio errors for debugging
    audioElement.addEventListener("error", () => {
      console.error("Audio error:", audioElement.error);
    });

    // Update active station button style
    function updateActiveStation(index, mode) {
      document.querySelectorAll(".station").forEach(el => {
        el.classList.remove("announcement-active", "station-active");
      });
      const stationButton = document.querySelector(`.station[data-index="${index}"]`);
      if (stationButton) {
        if (mode === "announcement") {
          stationButton.classList.add("announcement-active");
        } else if (mode === "station") {
          stationButton.classList.add("station-active");
        }
      }
    }

    // Update play/pause button icon
    function updatePlayPauseIcon() {
      playPauseBtn.textContent = audioElement.paused ? "▶" : "⏸";
    }
    audioElement.addEventListener("play", updatePlayPauseIcon);
    audioElement.addEventListener("pause", updatePlayPauseIcon);

    // Generate inner arrow circle
    function generateArrows() {
      const arrowContainer = document.getElementById("arrowContainer");
      arrowContainer.innerHTML = "";
      const containerWidth = arrowContainer.offsetWidth;
      const containerHeight = arrowContainer.offsetHeight;
      const centerX = containerWidth / 2;
      const centerY = containerHeight / 2;
      const arrowRadius = 300;
      const numArrows = 50;
      for (let i = 0; i < numArrows; i++) {
        const angle = (2 * Math.PI * i) / numArrows;
        const x = centerX + arrowRadius * Math.cos(angle);
        const y = centerY + arrowRadius * Math.sin(angle);
        const arrow = document.createElement("div");
        arrow.classList.add("arrow");
        arrow.textContent = "➤";
        arrow.style.left = x + "px";
        arrow.style.top = y + "px";
        const angleDeg = (angle * 180) / Math.PI;
        const rotationDeg = (playDirection === 1) ? angleDeg + 90 : angleDeg - 90;
        arrow.style.transform = `translate(-50%, -50%) rotate(${rotationDeg}deg)`;
        arrowContainer.appendChild(arrow);
      }
    }

    function updateArrowAnimation() {
      const arrowContainer = document.getElementById("arrowContainer");
      arrowContainer.style.animationName =
        (playDirection === 1) ? "spinClockwise" : "spinCounterClockwise";
      generateArrows();
    }

    // Place stations on outer circle
    function placeStations() {
      const stationsContainer = document.getElementById("stations");
      stationsContainer.innerHTML = "";
      const containerWidth = stationsContainer.offsetWidth;
      const containerHeight = stationsContainer.offsetHeight;
      const centerX = containerWidth / 2;
      const centerY = containerHeight / 2;
      const stationRadius = 380;
      const totalStations = stations.length;
      for (let i = 0; i < totalStations; i++) {
        const angle = (2 * Math.PI * i) / totalStations - Math.PI / 2;
        const x = centerX + stationRadius * Math.cos(angle);
        const y = centerY + stationRadius * Math.sin(angle);

        const stationDiv = document.createElement("div");
        stationDiv.classList.add("station");
        stationDiv.textContent = stations[i].name;
        stationDiv.style.left = x + "px";
        stationDiv.style.top = y + "px";
        stationDiv.dataset.index = i;
        stationDiv.addEventListener("click", () => {
          playStation(i);
        });
        stationsContainer.appendChild(stationDiv);
      }
    }

    // Playback logic
    function playStation(index) {
      currentStationIndex = index;
      const station = stations[index];
      audioElement.onended = null;
      updateActiveStation(index, "");

      // If skip announcements is OFF, play announcement first
      if (!skipAnnouncementToggle.checked) {
        currentAudioType = "announcement";
        currentStationLabel.textContent = station.name + " (announcement)";
        audioElement.src = station.mp3Announcement + cacheBust;
        audioElement.volume = announcementMuted ? 0 : announcementVolume;
        audioElement.play().then(() => {
          updateActiveStation(index, "announcement");
          audioElement.onended = () => {
            playStationAudio(station);
          };
        }).catch(err => {
          console.error("Announcement playback failed:", err);
          playStationAudio(station);
        });
      } else {
        // Skip announcements
        playStationAudio(station);
      }
    }

    function playStationAudio(station) {
      currentAudioType = "station";
      currentStationLabel.textContent = station.name;
      audio
