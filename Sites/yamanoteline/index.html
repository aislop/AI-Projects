<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Yamanote Line - Stations on Circle with Dark Mode</title>
  <!-- Content Security Policy; adjust if you later externalize scripts/styles -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Circle wrapper for arrows and station labels -->
  <div id="circleWrapper">
    <div id="arrowContainer"></div>
    <div id="stations"></div>
  </div>

  <!-- Audio bar fixed at the bottom (single horizontal row) -->
  <div id="audioPlayer">
    <div class="left-controls">
      <div class="volume-control">
        <span class="volume-label">Announcement</span>
        <button class="volume-icon" id="announcementVolumeIcon">üîä</button>
        <input type="range" id="announcementVolumeSlider" min="0" max="1" step="0.01" value="1">
      </div>
      <div class="volume-control">
        <span class="volume-label">Station</span>
        <button class="volume-icon" id="stationVolumeIcon">üîä</button>
        <input type="range" id="stationVolumeSlider" min="0" max="1" step="0.01" value="1">
      </div>
    </div>
    <div class="center-controls">
      <span id="currentStation">No station selected</span>
      <button id="playPauseBtn" class="control-button">‚ñ∂</button>
    </div>
    <div class="right-controls">
      <div class="switch-control">
        <span id="skipText">Skip Announcements</span>
        <label class="switch">
          <input type="checkbox" id="skipAnnouncement">
          <span class="slider round"></span>
        </label>
      </div>
      <div class="switch-control">
        <span id="directionText">Clockwise</span>
        <label class="switch">
          <input type="checkbox" id="directionToggle" checked>
          <span class="slider round"></span>
        </label>
      </div>
      <div class="switch-control">
        <span id="darkModeText">Light Mode</span>
        <label class="switch">
          <input type="checkbox" id="darkModeToggle">
          <span class="slider round"></span>
        </label>
      </div>
    </div>
  </div>

  <!-- Hidden audio element for playback -->
  <audio id="audio" preload="auto"></audio>

  <script>
    // Array of stations (using two folders: announcements and Sounds)
    const stations = [
      { name: "Tokyo", mp3Announcement: "Sites/yamanoteline/announcements/tokyo-announcement.mp3", mp3Station: "Sites/yamanoteline/sounds/Tokyo.mp3" },
      { name: "Kanda", mp3Announcement: "./announcements/Kanda-announcement.mp3", mp3Station: "./Sounds/Kanda.mp3" },
      { name: "Akihabara", mp3Announcement: "./announcements/Akihabara-announcement.mp3", mp3Station: "/Sounds/Akihabara.mp3" },
      { name: "Okachimachi", mp3Announcement: "./announcements/Okachimachi-announcement.mp3", mp3Station: "/Sounds/Okachimachi.mp3" },
      { name: "Ueno", mp3Announcement: "./announcements/Ueno-announcement.mp3", mp3Station: "/Sounds/Ueno.mp3" },
      { name: "Uguisudani", mp3Announcement: "./announcements/Uguisudani-announcement.mp3", mp3Station: "/Sounds/Uguisudani.mp3" },
      { name: "Nippori", mp3Announcement: "./announcements/Nippori-announcement.mp3", mp3Station: "/Sounds/Nippori.mp3" },
      { name: "Nishi-Nippori", mp3Announcement: "/announcements/Nishi-Nippori-announcement.mp3", mp3Station: "/Sounds/Nishi-Nippori.mp3" },
      { name: "Tabata", mp3Announcement: "/announcements/Tabata-announcement.mp3", mp3Station: "/Sounds/Tabata.mp3" },
      { name: "Komagome", mp3Announcement: "/announcements/Komagome-announcement.mp3", mp3Station: "/Sounds/Komagome.mp3" },
      { name: "Sugamo", mp3Announcement: "/announcements/Sugamo-announcement.mp3", mp3Station: "/Sounds/Sugamo.mp3" },
      { name: "Otsuka", mp3Announcement: "/announcements/Otsuka-announcement.mp3", mp3Station: "/Sounds/Otsuka.mp3" },
      { name: "Ikebukuro", mp3Announcement: "/announcements/Ikebukuro-announcement.mp3", mp3Station: "/Sounds/Ikebukuro.mp3" },
      { name: "Mejiro", mp3Announcement: "/announcements/Mejiro-announcement.mp3", mp3Station: "/Sounds/Mejiro.mp3" },
      { name: "Takadanobaba", mp3Announcement: "/announcements/Takadanobaba-announcement.mp3", mp3Station: "/Sounds/Takadanobaba.mp3" },
      { name: "Shin-Okubo", mp3Announcement: "/announcements/Shin-Okubo-announcement.mp3", mp3Station: "/Sounds/Shin-Okubo.mp3" },
      { name: "Shinjuku", mp3Announcement: "/announcements/Shinjuku-announcement.mp3", mp3Station: "/Sounds/Shinjuku.mp3" },
      { name: "Yoyogi", mp3Announcement: "/announcements/Yoyogi-announcement.mp3", mp3Station: "/Sounds/Yoyogi.mp3" },
      { name: "Harajuku", mp3Announcement: "/announcements/Harajuku-announcement.mp3", mp3Station: "/Sounds/Harajuku.mp3" },
      { name: "Shibuya", mp3Announcement: "/announcements/Shibuya-announcement.mp3", mp3Station: "/Sounds/Shibuya.mp3" },
      { name: "Ebisu", mp3Announcement: "/announcements/Ebisu-announcement.mp3", mp3Station: "/Sounds/Ebisu.mp3" },
      { name: "Meguro", mp3Announcement: "/announcements/Meguro-announcement.mp3", mp3Station: "/Sounds/Meguro.mp3" },
      { name: "Gotanda", mp3Announcement: "/announcements/Gotanda-announcement.mp3", mp3Station: "/Sounds/Gotanda.mp3" },
      { name: "Osaki", mp3Announcement: "/announcements/Osaki-announcement.mp3", mp3Station: "/Sounds/Osaki.mp3" },
      { name: "Shinagawa", mp3Announcement: "/announcements/Shinagawa-announcement.mp3", mp3Station: "/Sounds/Shinagawa.mp3" },
      { name: "Tamachi", mp3Announcement: "/announcements/Tamachi-announcement.mp3", mp3Station: "/Sounds/Tamachi.mp3" },
      { name: "Hamamatsucho", mp3Announcement: "/announcements/Hamamatsucho-announcement.mp3", mp3Station: "/Sounds/Hamamatsucho.mp3" },
      { name: "Shimbashi", mp3Announcement: "/announcements/Shimbashi-announcement.mp3", mp3Station: "/Sounds/Shimbashi.mp3" },
      { name: "Yurakucho", mp3Announcement: "/announcements/Yurakucho-announcement.mp3", mp3Station: "/Sounds/Yurakucho.mp3" }
    ];
    
    let currentStationIndex = -1;
    let announcementVolume = 1, stationVolume = 1;
    let announcementMuted = false, stationMuted = false;
    let currentAudioType = "";
    let playDirection = 1;
    
    const audioElement = document.getElementById("audio");
    const currentStationLabel = document.getElementById("currentStation");
    const skipAnnouncementToggle = document.getElementById("skipAnnouncement");
    const directionToggle = document.getElementById("directionToggle");
    const directionText = document.getElementById("directionText");
    const darkModeToggle = document.getElementById("darkModeToggle");
    const darkModeText = document.getElementById("darkModeText");
    const playPauseBtn = document.getElementById("playPauseBtn");
    
    // Dark mode toggle
    darkModeToggle.addEventListener("change", () => {
      if (darkModeToggle.checked) {
        document.body.classList.add("dark-mode");
        darkModeText.textContent = "Dark Mode";
      } else {
        document.body.classList.remove("dark-mode");
        darkModeText.textContent = "Light Mode";
      }
    });
    
    // Log audio errors for debugging
    audioElement.addEventListener("error", () => {
      console.error("Audio error:", audioElement.error);
    });
    
    // Update active station button style
    function updateActiveStation(index, mode) {
      document.querySelectorAll(".station").forEach(el => {
        el.classList.remove("announcement-active", "station-active");
      });
      const stationButton = document.querySelector(`.station[data-index="${index}"]`);
      if (stationButton) {
        if (mode === "announcement") {
          stationButton.classList.add("announcement-active");
        } else if (mode === "station") {
          stationButton.classList.add("station-active");
        }
      }
    }
    
    // Update play/pause button icon
    function updatePlayPauseIcon() {
      playPauseBtn.textContent = audioElement.paused ? "‚ñ∂" : "‚è∏";
    }
    audioElement.addEventListener("play", updatePlayPauseIcon);
    audioElement.addEventListener("pause", updatePlayPauseIcon);
    
    // Generate inner arrow circle
    function generateArrows() {
      const arrowContainer = document.getElementById("arrowContainer");
      arrowContainer.innerHTML = "";
      const containerWidth = arrowContainer.offsetWidth;
      const containerHeight = arrowContainer.offsetHeight;
      const centerX = containerWidth / 2;
      const centerY = containerHeight / 2;
      const arrowRadius = 300;
      const numArrows = 50;
      for (let i = 0; i < numArrows; i++) {
        const angle = (2 * Math.PI * i) / numArrows;
        const x = centerX + arrowRadius * Math.cos(angle);
        const y = centerY + arrowRadius * Math.sin(angle);
        const arrow = document.createElement("div");
        arrow.classList.add("arrow");
        arrow.textContent = "‚û§";
        arrow.style.left = x + "px";
        arrow.style.top = y + "px";
        const angleDeg = (angle * 180) / Math.PI;
        const rotationDeg = playDirection === 1 ? angleDeg + 90 : angleDeg - 90;
        arrow.style.transform = `translate(-50%, -50%) rotate(${rotationDeg}deg)`;
        arrowContainer.appendChild(arrow);
      }
    }
    
    function updateArrowAnimation() {
      const arrowContainer = document.getElementById("arrowContainer");
      arrowContainer.style.animationName =
        playDirection === 1 ? "spinClockwise" : "spinCounterClockwise";
      generateArrows();
    }
    
    // Place stations on outer circle
    function placeStations() {
      const stationsContainer = document.getElementById("stations");
      stationsContainer.innerHTML = "";
      const containerWidth = stationsContainer.offsetWidth;
      const containerHeight = stationsContainer.offsetHeight;
      const centerX = containerWidth / 2;
      const centerY = containerHeight / 2;
      const stationRadius = 380;
      const totalStations = stations.length;
      for (let i = 0; i < totalStations; i++) {
        const angle = (2 * Math.PI * i) / totalStations - Math.PI / 2;
        const x = centerX + stationRadius * Math.cos(angle);
        const y = centerY + stationRadius * Math.sin(angle);
        const stationDiv = document.createElement("div");
        stationDiv.classList.add("station");
        stationDiv.textContent = stations[i].name;
        stationDiv.style.left = x + "px";
        stationDiv.style.top = y + "px";
        stationDiv.dataset.index = i;
        stationDiv.addEventListener("click", () => {
          playStation(i);
        });
        stationsContainer.appendChild(stationDiv);
      }
    }
    
    // Playback functions
    function playStation(index) {
      currentStationIndex = index;
      const station = stations[index];
      audioElement.onended = null;
      updateActiveStation(index, "");
      const cacheBust = "?v=1";
      if (!skipAnnouncementToggle.checked) {
        currentAudioType = "announcement";
        currentStationLabel.textContent = station.name + " (announcement)";
        audioElement.src = `/announcements/${station.name}-announcement.mp3${cacheBust}`;
        audioElement.volume = announcementMuted ? 0 : announcementVolume;
        audioElement.play().then(() => {
          updateActiveStation(index, "announcement");
          audioElement.onended = () => {
            playStationAudio(station);
          };
        }).catch(err => {
          console.error("Announcement playback failed:", err);
          playStationAudio(station);
        });
      } else {
        playStationAudio(station);
      }
    }
    
    function playStationAudio(station) {
      currentAudioType = "station";
      currentStationLabel.textContent = station.name;
      const cacheBust = "?v=1";
      audioElement.src = station.mp3Station + cacheBust;
      audioElement.volume = stationMuted ? 0 : stationVolume;
      audioElement.play().then(() => {
        updateActiveStation(currentStationIndex, "station");
        audioElement.onended = () => {
          nextStation();
        };
      });
    }
    
    function nextStation() {
      let nextIndex = currentStationIndex + playDirection;
      if (nextIndex >= stations.length) nextIndex = 0;
      if (nextIndex < 0) nextIndex = stations.length - 1;
      playStation(nextIndex);
    }
    
    playPauseBtn.addEventListener("click", () => {
      if (audioElement.paused) audioElement.play();
      else audioElement.pause();
    });
    
    document.getElementById("announcementVolumeSlider").addEventListener("input", e => {
      announcementVolume = parseFloat(e.target.value);
      if (currentAudioType === "announcement" && !announcementMuted) {
        audioElement.volume = announcementVolume;
      }
    });
    document.getElementById("stationVolumeSlider").addEventListener("input", e => {
      stationVolume = parseFloat(e.target.value);
      if (currentAudioType === "station" && !stationMuted) {
        audioElement.volume = stationVolume;
      }
    });
    
    document.getElementById("announcementVolumeIcon").addEventListener("click", () => {
      announcementMuted = !announcementMuted;
      const icon = document.getElementById("announcementVolumeIcon");
      icon.textContent = announcementMuted ? "üîá" : "üîä";
      if (currentAudioType === "announcement") {
        audioElement.volume = announcementMuted ? 0 : announcementVolume;
      }
    });
    document.getElementById("stationVolumeIcon").addEventListener("click", () => {
      stationMuted = !stationMuted;
      const icon = document.getElementById("stationVolumeIcon");
      icon.textContent = stationMuted ? "üîá" : "üîä";
      if (currentAudioType === "station") {
        audioElement.volume = stationMuted ? 0 : stationVolume;
      }
    });
    
    directionToggle.addEventListener("change", () => {
      if (directionToggle.checked) {
        playDirection = 1;
        directionText.textContent = "Clockwise";
      } else {
        playDirection = -1;
        directionText.textContent = "Counterclockwise";
      }
      updateArrowAnimation();
    });
    
    window.onload = function() {
      generateArrows();
      updateArrowAnimation();
      placeStations();
    };
  </script>
</body>
</html>
